<#
.Synopsis
    Disable ActiveX controls per MSRC gidance
.DESCRIPTION
    This script is intended to mitigate MITRE CVE-2021-40444
    Reference: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-40444

    Required Script Variable:
        Name: BlockActiveX
        Type: Dropdown
        Values: False (Default)
                True
.NOTES
    Version:        1.2
    Author:         jrdnr
    Creation Date:  08/09/2021
    Purpose/Change: Resolve error with missing path, improved output
#>

$regRoot = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\CurrentVersion\Internet Settings\Zones"
foreach ($i in 0..3) {
    $regKey  = Join-Path -Path $regRoot -ChildPath $i
    if('False' -eq $BlockActiveX){
        Remove-Item -Path $regKey -Verbose
    } elseif (Test-Path -Path $regKey){
        Set-ItemProperty -Path $regKey -Name 1001 -Value 3 | Out-Null
        Set-ItemProperty -Path $regKey -Name 1004 -Value 3 | Out-Null
    } else {
        Write-Warning "$regKey Not Found"
        foreach ($child in $regKey.Split('\')) {
            $root = "$root\$child"
            if ($child -match ':') {
                $root = $child
            } elseif (!(Test-Path -Path "$root")) {
                New-Item -Path $root
            }
        }
        New-ItemProperty -Path $regKey -Name 1001 -Value 3 | Out-Null
        New-ItemProperty -Path $regKey -Name 1004 -Value 3 | Out-Null
    }
    [array]$return += Get-ItemProperty -Path $regKey -ErrorAction SilentlyContinue | Select-Object -Property @{n='ZoneKey';e={$i}},'1001','1004'
}

$return | Out-Host
