<#
.Synopsis
    Disable ActiveX controls per MSRC gidance
.DESCRIPTION
    This script is intended to mitigate MITRE CVE-2021-40444
    Reference: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-40444

    Required Script Variable:
        Name: BlockActiveX
        Type: Dropdown
        Values: False (Default)
                True
.NOTES
    Version:        1.0
    Author:         jrdnr
    Creation Date:  08/09/2021
    Purpose/Change: Initial script development
#>

foreach ($i in 0..3) {
    $regRoot = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\CurrentVersion\Internet Settings\Zones"
    $regKey  = Join-Path -Path $regRoot -ChildPath $i
    if('False' -eq $BlockActiveX){
        Remove-Item -Path $regKey
    } elseif (Test-Path -Path $regKey){
        $regKey
        Get-ItemProperty -Path $regKey | Select-Object -Property '1001','1004'
        Set-ItemProperty -Path $regKey -Name 1001 -Value 3
        Set-ItemProperty -Path $regKey -Name 1004 -Value 3
    } else {
        Write-Warning "$regKey Not Found"
        foreach ($child in $regKey.Split('\')) {
            $root = "$root\$child"
            if ($child -match ':') {
                $root = $child
            } elseif (!(Test-Path -Path "$root")) {
                New-Item -Path $root
            }
        }
        New-ItemProperty -Path $regKey -Name 1001 -Value 3
        New-ItemProperty -Path $regKey -Name 1004 -Value 3
    }
}
